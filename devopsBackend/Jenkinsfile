pipeline {
    agent {
        kubernetes {
            yaml '''
            apiVersion: v1
            kind: Pod
            metadata: 
              name: jenkins-agent
            spec:
              containers:
              - name: gradle
                image: gradle:8.10.0-jdk21
                command:
                - cat
                tty: true
              - name: docker
                image: docker:27.2.0-alpine3.20
                command:
                - cat
                tty: true
                volumeMounts:
                - mountPath: "/var/run/docker.sock"
                  name: docker-socket
              volumes:
              - name: docker-socket
                hostPath:
                  path: "/var/run/docker.sock"
            '''
        }
    }
    stages {
        stage('Checkout') {
            steps{
                git branch: 'main', 
                    credentialsId: 'github_access_ssh_samdasu',
                    url: 'git@github.com:uzz99/Samdasu-Devops.git'
            }
        }

        stage('Build Backend') {
            steps {
                container('gradle'){
                    dir('devopsBackend') {
                        sh 'chmod +x ./gradlew'
                        sh './gradlew clean build -x test'
                    }
                }
            }
        }

        stage('Docker Image Build'){
            steps {
                container('docker'){
                    sh 'docker logout'
                    withCredentials([usernamePassword(credentialsId: 'samdasu-dockerhub-access', 
                        usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD' )]){
                            sh 'echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin'
                    }

                    dir('devopsBackend') {
                        sh 'docker -v'
                        sh 'docker build --no-cache -t uzz99/samdasu_repo:fourstit-back-2.0 ./'
                        sh 'docker image inspect uzz99/samdasu_repo:fourstit-back-2.0'
                        sh 'docker push uzz99/samdasu_repo:fourstit-back-2.0'
                    }
                    sh 'docker logout'
                }
            }
        }
    }
}